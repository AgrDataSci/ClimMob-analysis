---
title: "`r project_name`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    reference_docx: word_style_template.docx
    toc: true
  html_document:
    toc: true
  pdf_document:
    toc: true
bibliography: ["climmob.bib"]
csl: citation_style.csl
---

```{r setup_opts, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      error = FALSE,
                      message=FALSE,
                      warning = FALSE)
```


# Introduction  

The primary goal of ClimMob is to support the selection of innovative technologies (*e.g.* new crop varieties, management, new products). ClimMob serves to prepare and analyze citizen science experiments in which a large number of participants observe and compare different technological options under a wide range of conditions [@vanEtten2019tricot]. 
 
ClimMob software assigns a limited number of items (typically 3) to each participant, who will compare their performance. Each participant gets a different combination of items drawn from a much larger set of items (typically 15-25). Once the results of the small tasks have been collected, ClimMob builds a data base of the whole set of tested technologies, combining all observations. ClimMob not only reconstructs the overall ordering of items, but also takes into account differences and similarities between participants and the conditions under which they observe (e.g. socio-economic and plot environmental traits). It assigns similar participants to groups that each corresponds among different group profiles. Groups are created on the basis of whichever items which have been collected, that are found to be significantly linked to the observed rankings.
 
ClimMob applies the Plackett-Luce model to analyze ranking data with the R [@RCoreTeam] package 'PlackettLuce' [@Turner2020]. It automatically generates analytical reports, as well as individualized information sheets for each participant using the R packages 'knitr' [@knitr] and 'rmarkdown' [@rmarkdown]. Organizing the data relies on packages 'ClimMobTools' [@climmobtools], 'gosset' [@gosset], 'gtools' [@gtools], 'jsonlite' [@jsonlite], 'partykit' [@partykit], 'psychotools' [@psychotools] and 'qvcalc' [@qvcalc]. Summaries and data visualization are supported by packages 'igraph' [@igraph], 'ggparty' [@ggparty], 'ggplot2' [@ggplot2], 'ggrepel' [@ggrepel], 'gridExtra' [@gridExtra] 'leaflet' [@leaflet], 'multcompView' [@multcompView], 'patchwork' [@patchwork], 'png' [@png], 'plotrix' [@plotrix] and 'pls' [@pls]. Agroclimatic indices are obtained using the packages climatrends [@climatrends] and nasapower [@nasapower]. The decentralized experimental approach behind ClimMob is introduced by van Etten et al. (2019) [@vanEtten2019tricot]. To cite ClimMob itself, mention van Etten et al. (2020) [@climmob]. The workflow used to produce this report is documented by de Sousa et al. (2022) [@climmobanalysis].

\pagebreak

# Trial overview

Overall, there were `r nparticipants` `r participants` contributing to this trial. Each `r participant` assessed `r noptions` different `r options` and provided rankings for `r ntraits` trait(s). 

```{r traits}
kable(overview_and_summaries$summary_table_trait, 
      caption = paste0("Table 1.1. Summary of traits and number of observations (answers) per trait used in this report."), row.names = FALSE, align = "l")

```

\

The rate of response in each trial stage (data collection moment) is presented in Figure 1.1. This gives an overview of the level of participation during the trial and any attrition (when participants leave the experiment). 

\

```{r progress, dpi=dpi, fig.height=7, fig.width=10, fig.cap=paste0("Figure 1.1. Rate of response during trial stages (data collection moments).")}
plot(overview_and_summaries$partipation_plot)
```

\

```{r trial_map_statement}
trial_map_statement <- ""
if (isTRUE(trial_map$geoTRUE)){
  trial_map_statement <- paste0("The map below shows the distribution ",
                               "of the plots in this trial. To respect ",
                               participants, "' privacy, the coordinates ",
                               "were clustered with a 0.05 arc-degree resolution. You can find ",
                               "the original coordinates in your ClimMob data.")
}
```

`r paste(trial_map_statement, collapse='\n')`

```{r map, dpi=dpi, out.width = '70%', fig.cap=paste0("Distribution of trial plots. Coordinates were clustered with a 0.05 arc-degree resolution.")}
if (isTRUE(trial_map$geoTRUE)) {
try(knitr::include_graphics(trial_map$map_path), silent = TRUE)
}
```

```{r agroclimate}
agroclimate_text1 <- ""
if (isTRUE(agroclimate$agroclimate)){
  agroclimate_text1 <- paste0("The charts bellow present the temperature and rainfall indices ",
                              "obtained using the GPS data presented in the map. The timespan ",
                              "window used to capture the climate data were from ",
                              paste(agroclimate$dates, collapse = " to "), ". The charts ",
                              "present the weekly agroclimatic indices (7-days). Data was obtained ",
                              " using the R package nasapower [@nasapower], indices were computed using the ",
                              "R package climatrends [@climatrends].")
}
```

`r paste(agroclimate_text1, collapse = '\n')`

```{r temperature_indices, dpi=dpi, fig.height=10, fig.width=10, fig.cap=paste0("Temperature indices from ", paste(agroclimate$dates, collapse = " to "), ". The chart presents weekly (7-days) maximum day temperature (maxDT), the minimum day temperature (minDT), the maximum night temperature (maxNT), and the minimum nigth temperature (minNT).")}
if (isTRUE(agroclimate$agroclimate)){
plot(agroclimate$temperature_plot)
}
```

\

```{r rainfall_indices, dpi=dpi, fig.height=10, fig.width=10, fig.cap=paste0("Rainfall indices from ", paste(agroclimate$dates, collapse = " to "), ". The chart presents weekly (7-days) total rainfall (Rtotal), simple daily intensity index, total precipitation divided by the number of wet days (mm/days, SDII), maximum length of consecutive dry day, rain < 1 mm (MLDS), and the maximum length of consecutive wet days, rain >= 1 mm (MLWS).")}
if (isTRUE(agroclimate$agroclimate)){
plot(agroclimate$rain_plot)
}
```


Table 1.2 shows the `r ntechnologies` `r options` assessed in this trial, with the frequency and percentage of `r participants` who assessed each `r option`. If the `r options` have large names (> 12 characters) an abbreviation is applied across the figures in this report.

```{r itemtable}
kable(overview_and_summaries$summary_table_tech, 
          caption = paste0("Table 1.2. Frequency of ", options," assessed in this trial."),
          align = "l",
          row.names = FALSE)
```

\

Figure 1.2 shows that the `r ntechnologies` are all connected to each other. That means that they all co-occurred at least once in an incomplete block of `r noptions` `r options`. 

```{r trial_network, dpi=dpi, fig.height=7, fig.width=7, fig.cap=paste0("Figure 1.2. Experimental network representation of ", options, " tested in this trial.")}
plot(overview_and_summaries$trial_connectivity)
```

\

# Summary of `r options`' performance

```{r stat_diff_statement}
# make the statement for the report about the statistical significance
stat_diff_statement <- paste0("This report takes the trait '", reference_trait, 
                              "' as the reference trait for the analysis.",
                              " A summary of the p-values testing the hypothesis ",
                              "that there were differences in ", option, 
                              " performance for each trait, and the list of ", options,
                              " which showed significant ",
                              "best and worst performance, are summarized in Table 1.3.")
```

`r paste(stat_diff_statement, collapse='\n')`

\

```{r pl_models_overview}
kable(PL_models$PL_models_overview, 
      caption = paste0("Table 1.3. Summary of ", option," performance trait. The table shows up to three ", options,
                       " with best and worst performance based on the log-worth estimates obtained with Plackett-Luce models."),
      row.names = FALSE)
```


\

```{r relation_other_chrs} 
relation_other_chrs1 <- ""
relation_other_chrs2 <- ""
relation_other_chrs3 <- ""
if ((isTRUE(PL_models$kendall$isKendall))) {
relation_other_chrs1 <- 
  paste0("Figure 1.3 shows, the Kendall tau coefficient[@Kendall1938] which represents the ",
         " correlation between the '", reference_trait, "' and the other traits assessed in the trial.", 
        " The coefficient is an equivalent of a Pearson ", 
        "correlation designed for ranking data, ranging from -1 to 1, where 1 means a total correlation and -1 a total negative correlation.")

relation_other_chrs2 <- 
  paste0("The trait that had the strongest ", 
        "correlation with '", reference_trait, "' was '", 
        PL_models$kendall$strongest_link[1], 
        "' with a Kendall tau of ",
        PL_models$kendall$strongest_link[2],
        ". The trait that had the weakest correlation with '", 
        reference_trait,
        "' was '", PL_models$kendall$weakest_link[1], 
        "' with a Kendall tau of ", 
        PL_models$kendall$weakest_link[2], ".")
}

if (isTRUE(length(PL_models$worthmap) > 0)) {
  relation_other_chrs3 <- paste0("The log-worth by trait of each ",
                                 option, 
                                 " tested in this trial is presented in Figure 1.4.",
                                 " The chart shows for each trait the ", options, 
                                 " with higher and weakest performance compared to",
                                 " the reference ", option, " ", reference_tech, ".",
                                 " The values are adjusted to the log scale",
                                 " where log-worth > 0 (blue) represents the ", options, 
                                 " with superior performance for the given trait, ",
                                 " whereas worth < 0 (red) represents the ", options, 
                                 " with the lower performance for the given trait.")
    
}

```

`r paste(relation_other_chrs1, collapse='\n')`

```{r kendall_tau_plot, dpi = dpi, fig.height=7, fig.width=7, fig.cap=paste0("Fig. 1.3. Correlation between '", reference_trait, "' and the other traits assessed in this trial. The chart displays Kendall correlation coefficients.")}
if (isTRUE(PL_models$kendall$isKendall)) {
  plot(PL_models$kendall$kendall_plot)
}
```

\

`r paste(relation_other_chrs2, collapse='\n')`

\

`r paste(relation_other_chrs3, collapse='\n')`


```{r worthmap, dpi=dpi,fig.height=worthmap_h, fig.width=worthmap_h, fig.cap= paste0("Figure 1.4. ", title_case(option), " performance by trait. The chart display log-worth values where worth > 0 (blue) represents the ", options, " with superior performance for the given trait, whereas worth < 0 (red) represents the ", options, " with the lower performance for the given trait. The ", option, " ", reference_tech, " is set as refence (log-worth arbitrarily set to zero).")}
plot(PL_models$worthmap)
```


Figure 1.5 shows the estimated log-worth for the grouped rankings of all `r ntraits` traits. This analysis combines all the rankings provided for each trait into a single list of grouped rankings, thus giving insights on `r option` performance across all the traits. The purpose is to be able to distinguish the `r option` with the highest overall performance. As such, it can be concluded that a higher log-worth indicates that a `r option` has best performance overall. While the lowest log-worth shows `r option` with weakest performance overall. Mean separation analysis was also conducted to indicate, using letters, which `r option` is significantly different (or similar) to the others. When `r options` have at least one letter in common, there is not enough evidence from the trial to be confident about their relative order at the alpha = `r sig_level`.

```{r est_plot, dpi=dpi, fig.height=5, fig.width=6, fig.cap=paste0("Figure 1.5. Plackett-Luce Model estimates (log-worth) of tested ", options, " obtained from grouped rankings combining the performance of ", options, " in the ", ntraits, " traits assessed in this trial. The ", option, " ", reference_tech, " is set as reference (log-worth arbitrarily set to zero). Intervals based on quasi standard errors.")}
plot(PL_models$logworth_grouped_rank)
```

\

# Effect of covariates on `r options`' performance 

A model-based recursive partitioning approach [@Strobl2009] was used to determine the effect of covariates on the `r option` performance. This approach identifies sub-groups in the data for which the `r option` performance is significantly different. This analysis required that all rankings and covariates are completely available for the entire data set. Here we used `r PL_tree$nobservations_used_tree` out of `r nparticipants` valid rankings. We report the performance of `r options` using the grouped rankings as described in the previous section. 

To select the covariate(s) that best represent the data set, a stepwise regression based on the forward selection approach was used. The procedure begins by fitting each covariate individually and adding new covariates one by one when it makes a single best improvement to the model based on the Akaike Information Criterion (AIC) [@Sakamoto1986]. The AIC estimates the relative amount of information lost by a given model, the less information a model loses, the higher the quality of that model. In the Plackett-Luce trees, the AIC is obtained by adding the maximized log likelihood ($L$) to the degrees of freedom ($\nu$). 

Equation [1]
$$AIC = -2L +  2\nu$$
Based on this approach, the following model was applied to the data: 

> `r PL_tree$tree_formula`

```{r tree_test}
tree_test1 <- ""
tree_test2 <- ""
tree_test3 <- ""
if (isFALSE(PL_tree$isTREE)) {
  tree_test1 <- 
    paste0("However, no differences based on the covariates provided were found. This could mean many things, some of the possible reasons is that there is no difference at all between groups, or that very few data was provided, or that a different set of covariates and model parameters should be used. Please contact the ClimMob team for further assistance.")
}

if (isTRUE(PL_tree$isTREE)) {
  tree_test1 <- 
    paste0("Table 1.4 presents the node groups that were obtained from the Plackett-Luce trees using the set of covariates retained by the forward selection.")
  
  if (isTRUE(agroclimate$agroclimate)) {
   tree_test1 <- paste0(tree_test1, 
           "We also included a set of agroclimatic covariates to the PlackettLuce trees.",
           "The indices are computed for each recorded location from the ",
           paste(agroclimate$dates, collapse = " to "),
           "Please check the documentation of the climatrends package for a full description of agroclimatic covariates < https://agrdatasci.github.io/climatrends/ >.")
  }
  
  tree_test2 <- 
    paste0("Figure 1.6 shows the Plackett-Luce tree obtained with the selected model.")
  
  tree_test3 <- 
    paste0("Table 1.5 present the worth and regret values across the tree nodes. This provides an approach to select ", options, " with the higher performance across all nodes in the tree and can be used as a risk assessment approach.")
}

```

`r paste(tree_test1, collapse='\n')`

\

```{r tree_node_table}
if(isTRUE(PL_tree$isTREE)){
kable(PL_tree$node_summary, 
        caption = paste0("Table 1.4. Summary of node groups identified",
                         " by the model-based recursive partitioning tree applied to the Plackett-Luce rankings."),
        row.names = FALSE)
}

```

\

`r paste(tree_test2, collapse='\n')`

\

```{r pltree, dpi=500, asis=TRUE,fig.height=8,fig.width=10, fig.cap = paste0("Fig. 1.6. Plackett-Luce tree of tested ", options, ". The horizontal axis of each panel is the log-worth. Error bars show quasi-SEs.")}
if (isTRUE(PL_tree$isTREE)) {
plot(PL_tree$PLtree_plot)
}
```

\

`r paste(tree_test3, collapse='\n')`

\

```{r regret_table}
if(isTRUE(PL_tree$isTREE)){
kable(PL_tree$regret_table, 
        caption = paste0("Table 1.5. Expected probability of winning (worth) and worst regret measures. The results show how different criteria of ", option, " selection can lead to different recommendations (high worth and low regret values mean a good option). Using the worth as a criterion maximizes the average performance but ignores risk. Minimizing worst regret (the loss under the worst possible outcome) is a criterion that takes a conservative approach to risk."),
        row.names = FALSE)
}

```

```{r quantitative_test}
quanti_caption <- ""
quanti_test1 <- ""
if (isTRUE(length(quantitative_traits$density_plots) > 0)) {
  quanti_caption <- "# Summary of quantitative traits"
  quanti_test1 <- 
    paste0("This section presents an exploratory analysis of the quantitative traits collected in the trial. Since each trait has its own distribution and requires individual data cleaning process, we cannot present models for the traits. Here we present density plots to help in the visualization of data distribution and possible outliers (which are fully described in the Appendix), to read more about density plots please visit this blog < https://www.data-to-viz.com/graph/density.html >. If you identify outliers, you can adjust the values on your ClimMob project and request a new report. The following presents the density plots for the traits measured in this trial.")
}

```

`r paste(quanti_caption, collapse='\n')`

`r paste(quanti_test1, collapse='\n')`

```{r denstity_plot, dpi=500, asis=TRUE,fig.height=8,fig.width=10}
if (isTRUE(length(quantitative_traits$density_plots) > 0)) {
for(i in seq_along(quantitative_traits$density_plots)) {
  plot(quantitative_traits$density_plots[[i]])
}
}
```


\pagebreak

# References

::: {#refs}
:::

# Appendix

```{r error}
error_caption <- ""
error_text1 <- ""
if (isFALSE(is.null(error))){
  error_caption <- "## Errors producing the report"
  error_text1 <- paste("During the execution of the requested analysis",
             "we found the following error(s).",
             "Please report the error(s) to", 
             "Kauê de Sousa <k.desousa(at)cgiar.org> and",
             "to Brandon Madriz <bmadriz(at)mrbotcr.com>.")
}
```

`r paste(error_caption, collapse = '\n')`

`r paste(error_text1, collapse = '\n')`

```{r error2}
if (isFALSE(is.null(error))){
print(error)
}
```

\pagebreak

```{r outlier_text}
outlier_caption <- ""
if (isTRUE(nrow(quanti_dat$outliers) > 0)){
  outlier_caption <- "## Outliers identified in quantitative traits"
}
```

`r paste(outlier_caption, collapse = '\n')`

```{r outlier}
if (isTRUE(nrow(quanti_dat$outliers) > 0))
kable(quanti_dat$outliers, 
          caption = paste0("Appendix 1.1. Possible outliers identified in quantitative data collected in the trial. If you consider any of these as outliers, please adjust it in your ClimMob project and request a new report."),
          align = "l",
          row.names = FALSE)
```
