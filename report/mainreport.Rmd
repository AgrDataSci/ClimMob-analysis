---
title: "`r paste('Report of ClimMob project ', projname)`"
author: "ClimMob.net"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    reference_docx: word_style_template.docx
    toc: true
  html_document:
    toc: true
  pdf_document:
    toc: true
bibliography: ["climmob.bib"]
csl: citation_style.csl
---

```{r setup_opts, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      error = FALSE,
                      message=FALSE,
                      warning = FALSE)
```


# Introduction  

In agriculture, the local environmental conditions determine to a large degree which technological solutions are the most suitable. In dry soils, for example, drought-resistant crop varieties will outperform other varieties, but in wet soils these same varieties may do worse than most. Not only drought, but an entire range of problems including excessive heat, floods, new pests and diseases tend to intensify under climate change. This multitude of limiting factors requires multiple technological solutions, tested in diverse environments. 
 
Citizen science is based on the cooperation of 'citizen scientists' or observers (paid or unpaid). Researchers assign small tasks (observations, experiments) that, once completed and gathered, contribute with a great amount of information to science. One of the advantages of citizen science is that agricultural researchers can get access to many environments by crowdsourcing their experiments. As farmers contribute with their time, skills and knowledge to the investigation, researchers are able to do more tests than in a traditional experimental design. Also citizen scientists acquire new knowledge, abilities and information useful for future challenges of their work.

## ClimMob

The primary goal of ClimMob is to support the selection of innovative technologies (*e.g.* new crop varieties, management, new products). ClimMob serves to prepare and analyze citizen science experiments in which a large number of participants observe and compare different technological options under a wide range of conditions [@vanEtten2019tricot]. 
 
ClimMob software assigns a limited number of items (typically 3) to each participant, who will compare their performance. Each participant gets a different combination of items drawn from a much larger set of items (typically 15-25). Once the results of the small tasks have been collected, ClimMob builds a data base of the whole set of tested technologies, combining all observations. ClimMob not only reconstructs the overall ordering of items, but also takes into account differences and similarities between participants and the conditions under which they observe (e.g. socio-economic and plot environmental traits). It assigns similar participants to groups that each corresponds among different group profiles. Groups are created on the basis of whichever items which have been collected, that are found to be significantly linked to the observed rankings.
 
ClimMob applies the Plackett-Luce model to analyze ranking data with the R [@RCoreTeam] package 'PlackettLuce' [@Turner2020]. It automatically generates analytical reports, as well as individualized information sheets for each participant using the R packages 'knitr' [@knitr] and 'rmarkdown' [@rmarkdown]. Organizing the data relies on packages 'ClimMobTools' [@climmobtools], 'gosset' [@gosset], 'gtools' [@gtools], 'jsonlite' [@jsonlite], 'partykit' [@partykit], 'psychotools' [@psychotools] and 'qvcalc' [@qvcalc]. Summaries and data visualization are supported by packages 'igraph' [@igraph], 'ggparty' [@ggparty], 'ggplot2' [@ggplot2], 'ggrepel' [@ggrepel], 'gridExtra' [@gridExtra] 'leaflet' [@leaflet], 'multcompView' [@multcompView], 'patchwork' [@patchwork], 'png' [@png], 'plotrix' [@plotrix] and 'pls' [@pls].
 

## How to cite

If you publish any results generated with ClimMob, you should cite a number of articles as the package builds on various contributions. The crowdsourcing philosophy behind ClimMob is introduced by van Etten et al. (2019) [@vanEtten2019tricot]. It is important to mention that ClimMob is implemented in R, a free, open-source analysis software [@RCoreTeam]. Methodologically, if you report on the Plackett-Luce tree results, you should mention that ClimMob applies the Plackett-Luce model, jointly attributed to Luce (1959) [@Luce1959] and Plackett (1975) [@Plackett1975], and implemented in R by Turner et al. 2020 [@Turner2020]. To cite ClimMob itself, mention van Etten et al. (2020) [@climmob]. The workflow used to produce this report is documented by de Sousa et al. (2021) [@climmobanalysis].

\pagebreak

# Section 1: Headline results

Overall, there were `r nranker` `r rankers` registered to this project. Each `r ranker` assessed `r ncomp` different `r options` and ranked them in order of its '`r Ovname`'. In addition, they also provided rankings for `r length(trait$name) -1` additional trait(s). 

```{r trait_drop}

trait_note <- ""

if (length(trait_dropped) > 0) {
  if(length(trait_dropped) > 1) {
    verb <- " were "
    adj <- " traits "
    noun <- " they "
  }else{
    verb <- " was "
    adj <- " trait "
    noun <- " it "
  }
  
  trait_note <- paste0("The", adj, paste3(trait_dropped), verb, "not considered in this report because", noun, "did not surpass the thresholds of (1) having at least ", minN, " valid entries, and (2) that all the ", options, " are tested at least ", minitem, " times twice per given trait. Table 1.1. shows the traits analysed in this report.")
}
```

`r paste(trait_note, collapse='\n')`

\

```{r traits}
try(
kable(tbl_section1, 
      caption = paste0("Table 1.1. Summary of traits and number of observations (answers) per trait used in this report."),
      row.names = FALSE,
      align = "l"),
silent = TRUE)

```

\

The rate of response in each trial stage (data collection moment) is presented in Figure 1.1. This gives an illustration of the level of participation during the experiment and any attrition (when participants leave the experiment). 

\

```{r progress, dpi=dpi, fig.height=7, fig.width=10, fig.cap=paste0("Figure 1.1. Rate of response during trial stages (data collection moment) in this project.")}
try(partiplot)
```

\

```{r trial_map_statement}
trial_map_statement <- ""
if (isTRUE(geoTRUE)){
  trial_map_statement <- paste0("The map below shows the distribution ",
                               "of the trials in this project. If you registered ", 
                               "more than one GPS location per ", ranker, ", the map ",
                               "shows the GPS registry which had the largest number ",
                               "of valid GPS records. We used the GPS points from '", 
                               gsub("_lon", "", lon),"'. To respect ",
                               ranker, "'s privacy, the coordinates ",
                               "were clustered with a 0.05 arc-degree resolution. You can find ",
                               "the original coordinates in your ClimMob data.")
}
```

`r paste(trial_map_statement, collapse='\n')`

```{r map, dpi=dpi, out.width = '70%'}
if (isTRUE(geoTRUE)) {
  if (extension == "html") {
    trial_map
  }else{
    try(knitr::include_graphics(paste0(outputpath, "/", projname, "_trial_map.png")), silent = TRUE)
  }
}
```

\

```{r local}
usedlocal <- ""
if(tricotVSlocal) {
  usedlocal <- paste0("Additionally, ", rankers, " were asked to compare the ", length(items), " ", options, " against the ", option, " currently used by them.")
}
```


Table 1.2 shows the `r length(items)` `r options` assessed in this experiment, with the frequency and percentage of `r rankers` who assessed each `r option`. `r usedlocal` If the `r options` have large names (> 10 characters) an abbreviation was applied across the figures in this report.

```{r itemtable}
try(kable(itemtable, 
          caption = paste0("Table 1.2. Frequency of ", options," assessed in this experiment."),
          align = "l",
          row.names = FALSE), silent = TRUE)
```

\

Figure 1.2 shows that the `r options` are all connected to each other. That means that they all co-occurred at least once in an incomplete block of `r ncomp` `r options`. 

```{r network, dpi=dpi, fig.height=7, fig.width=7, fig.cap=paste0("Figure 1.2. Network representation of ", options, " tested in this experiment.")}
if (isTRUE("igraph" %in% class(net))){
 try(igraph::plot.igraph(net,
                         edge.arrow.size = 0.5), silent = TRUE)
}
```

\

## Overall differences in rankings

```{r stat_diff_statement}
# make the statement for the report about the statistical significance
stat_diff_statement <- paste0("This report takes the trait '", Ovname, 
                              "' as the reference trait for the analysis.",
                              " A summary of the p-values testing the hypothesis ",
                              "that there were differences in the rankings for each ",
                              "trait, and the list of ", options, " which showed significant ",
                              "best and worst performance, are summarized in Table 1.3.")
```

`r paste(stat_diff_statement, collapse='\n')`

\

```{r summ_differences}
try(
  kable(overview_mod, 
      caption = paste0("Table 1.3. Summary of ",options," with best and worst performance by trait and data collection moment. The table shows up to three ", options, " with best and worst performance based on the log-worth estimated by the Plackett-Luce model from the evaluations given by the participants in this experiment."),
      row.names = FALSE),
  silent = TRUE)
```


\

```{r relation_other_chrs} 
relation_other_chrs1 <- ""
relation_other_chrs2 <- ""
relation_other_chrs3 <- ""
relation_other_chrs4 <- ""
if (isAGREE) {
relation_other_chrs1 <- 
  paste0("Table 1.4 shows, for each trait evaluated in the project, ", 
        "the frequency for which the rankings matched with the trait '", Ovname, 
        "'. Kendall tau shows the complete ranking agreement ", 
        "on the ranking with the trait '", 
        Ovname, "' as reference using the Kendall correlation ", 
        "coefficient [@Kendall1938]. The coefficient is an equivalent of a Pearson ", 
        "correlation designed for ranking data, ranging from -1 to 1, where 1 means a total correlation and -1 a total negative correlation.")

relation_other_chrs2 <- 
  paste0("The trait that had the strongest ", 
        "correlation with '", Ovname, "' was '", 
        strongest_link[1], 
        "'. The rankings for '", strongest_link[1], 
        "' correlate with '", Ovname, "' with a Kendall tau of ",
        strongest_link[2],
        ". The trait that had the lowest correlation with ", Ovname,
        "' was '", weakest_link[1], 
        "'. The rankings for '" ,  
        weakest_link[1], "' had a Kendall tau of ", 
        weakest_link[2], " when compared to '",  Ovname, 
        "'. The correlation with the other traits is also shown in Figure 1.3.")
}

if (length(worthmap) > 0) {
  relation_other_chrs3 <- paste0("The worth (probability of winning) by trait of each ",
                                 option, 
                                 " tested in this experiment is highlighted in Figure 1.4.",
                                 " The chart shows in which trait the ", options, 
                                 " have higher performance based on the ", rankers, 
                                 " evaluations. The values are adjusted to the log scale",
                                 " where worth > 0 (blue) represents the ", options, 
                                 " with superior performance for the given trait, ",
                                 " whereas worth < 0 (red) represents the ", options, 
                                 " with the lower performance for the given trait.")
    
}

if (isPLADMM) {
  relation_other_chrs4 <- 
  paste0("The Alternating Directions Method of Multipliers (ADMM) algorithm [@Yildiz2020] was applied to each model log-worth as a linear function of item covariates. ",
         "In this report, the log-worth of the ", nothertraits, " other traits were used as a item covariate,  or the intrinsic characteristics of the tested ", options, " to check  whether any if these traits have a significant influence to the rankings of the reference trait (", ovname, ").", 
         " The log-worth of ", trait_to_overall, " showed statistical correlation in explaining the performance of the ", options, " tested in this experiment. A full description of the log-worth estimates for each trait is presented in Table 1.5." )
  
  if (length(otn_rmv) > 0) {
    relation_other_chrs4 <- paste0(relation_other_chrs4, 
                                   " The traits ", paste3(otn_rmv, lan = language), " were not used in this analysis due to multicollinearity.")
  }
  
}

```

`r paste(relation_other_chrs1, collapse='\n')`

```{r agreement_table}
if (isAGREE) {
try(
  kable(kendall,
      caption = paste0("Table 1.4. Kendall correlation between '", Ovname, 
                       "' and the other traits assessed in this experiment." ),
      row.names = FALSE),
  silent = TRUE)
}
```

\

`r paste(relation_other_chrs2, collapse='\n')`

\

`r paste(relation_other_chrs3, collapse='\n')`


```{r worthmap, dpi=dpi,fig.height=worthmap_h, fig.width=worthmap_h, fig.cap= paste0("Figure 1.4. Probability of winning (worth) by traits of ", options, " tested in this experiment. The values are adjusted to the log scale where worth > 0 (blue) represents the ", options, " with superior performance for the given trait, whereas worth < 0 (red) represents the ", options, " with the lower performance for the given trait.")}
if (length(worthmap) > 0) {
  try(worthmap, silent = TRUE)
}
```


\


`r paste(relation_other_chrs4, collapse='\n')`

```{r pladmm}
if (isPLADMM) {
try(
  kable(plad1,
      caption = paste0("Table 1.5. Model coefficients (log-worth) by item covariates estimated by the Alternating Directions Method of Multipliers (ADMM) algorithm to represent their influence to the rankings given to '", Ovname  , "'." ),
      row.names = FALSE),
  silent = TRUE)
}
```


\pagebreak


# Section 2: `r Ovname`, data summary and exploratory analysis

## Assessment of `r options` 

Exploratory analysis within the following section summarises results from the rankings on '`r Ovname`'. Results from other sections, and in the overall summary use Plackett-Luce models [@Turner2020]. Performance of each of the `r options` for '`r Ovname`' is summarized in Table 2.1. The table below shows the number of times each `r option` was tested and the proportion of times it was ranked as the best or worst. Net favorability score is the different between the best and worst ranks for each `r option`. A score of +100 indicates that the `r option` won all 'contests' it was involved in, a score of 0 indicates an equal number of wins and losses, a score of -100 indicates the `r option` lost all contests. 


```{r fav_table}
try(knitr::kable(fav_traits[[1]][[reference_trait]],
             row.names = FALSE,
             caption = paste0("Table 2.1. Favorability scores for '", 
                              Ovname, "'." )), 
    silent = TRUE)
```

\

This shows the percentage of `r rankers` who assessed the `r options` as the best among the `r ncomp` `r options` they were provided, the percentage of `r rankers` who included the `r option` as their worst, the percentage of 'head-to-head contests' for which the `r option` won and the net favorability score (Figure 2.1). 

```{r fav_plot, dpi=dpi, fig.height=favplot_h, fig.width=6, fig.cap= paste0("Figure 2.1. Net favorability scores for '", Ovname, "'.")}
try(fav_traits[[2]][[reference_trait]])
```

\

```{r best_items}
best_items <- ""
if (isTRUE(nrow(fav_traits[[1]][[reference_trait]]) > 0)) {
  best_items <-
  try(paste("The", option, fav_traits[[1]][[reference_trait]][1,1], "was the top ranked", option, 
  " for the trait ", ovname, " being ranked highest by", 
  fav_traits[[1]][[reference_trait]][1,3], "of the" , 
  itemtable[itemtable$Variety %in% fav_traits[[1]][[reference_trait]][1,1], 3], 
  rankers, "who assessed this", option, "."), silent = TRUE)
  
  if ("try-error" %in% class(best_items)){
    best_items  <- ""
  }
  
}
```

`r paste(best_items, collapse = '\n')`

\

## Plackett-Luce Model estimates

\

Table 2.2 shows the results from the likelihood ratio test from the Plackett-Luce model for the trait '`r Ovname`' of the different `r options`. The hypothesis being tested is that there is no difference in the assessments of any of the different `r options`.

```{r, aov1}
try(kable(aov_tbl[[reference_trait]], 
      caption = paste0("Table 2.2. Likelihood ratio test results from fitted ", 
      "Plackett-Luce model with rankings from '", 
      Ovname, "'."),
      row.names = FALSE),
  silent = TRUE)
```

\

Figure 2.2 shows the estimated log-worth with `r ci_level*100`% confidence intervals. The purpose of this graph is to be able to best distinguish between the relative strength of each of the `r options` assessed. As such the log-worth are not directly interpretable, but it can be concluded that a higher value for the coefficient indicates that a `r option` has a higher probability of being the `r option` with higher performance. The `r ci_level*100`% confidence width is chosen so that non-overlapping confidence intervals could be interpreted as indicating significant differences at the alpha = `r sig_level`. This may not match exactly with the mean separation groupings, as these groupings also take into account multiple testing through the Benjamini and Hochberg adjustment [@BHtest].

Mean separation analysis was also conducted to indicate, using letters, which `r options` are significantly more preferred than others in terms of '`r Ovname`'. When `r options` have at least one letter in common, there is not enough evidence from the experiment to be confident about their relative order at the alpha = `r sig_level`.

```{r est_plot, dpi=dpi, fig.height=multcomp_h, fig.width=6, fig.cap=paste0("Figure 2.2. Plackett-Luce Model estimates (log-worth) of tested ", options, " for '", Ovname,". The ", option, " ", reference, " is set as reference (log-worth arbitrarily set to zero). Intervals based on quasi standard errors.")}
try(logworth_plot[[reference_trait]], silent = TRUE)
```

\


Figure 2.3 shows the worth parameters (probability of being the best) from the Plackett-Luce model in a direct comparison between all of the possible `r options`.

\

```{r rankedfirst, dpi=dpi, fig.height=favplot_h, fig.width=5, fig.cap= paste0("Figure 2.3. Worth parameters (probability of being the best ranked) for '", Ovname, "'.")}
try(worth_plot[[reference_trait]],
  silent = TRUE)
```

\

## Plackett-Luce Tree  

A model-based recursive partitioning method [@Strobl2009] was used to determine the effect of covariates in the rankings of `r Ovname`. This approach identifies sub-groups in the data for which the rankings are significantly different to each other. This analysis required that all rankings and covariates are completely available for the entire data set. Here we used `r dim(Gdata)[[1]]` out of `r sum(trait_list[[reference_trait]]$keep)` valid rankings for `r Ovname`. 

```{r covar_statement}
# make the statement if there is any covariate dropped
covar_statement <- ""
if (covarTRUE) {
  covar_statement <- paste0("You provided the covariate(s): ", paste3(sort(covar$name), lan = language), ". ")
  if (isTRUE(length(covar_dropped) > 0)) {
    covar_statement <- paste0(covar_statement,
      "However, the covariates(s) '", paste3(covar_dropped, lan = language),
      "' were not used in the analysis, because they did not surpass ",
      "the threshold of at least ", paste0(mincovar * 100, "%"), " valid entries."
    )
  }
}
```

`r  paste(covar_statement, collapse='\n')`

To select the covariate(s) that best represent the data set, a stepwise regression based on the forward selection approach was used. The procedure begins by fitting each covariate individually and adding new covariates one by one when it makes a single best improvement to the model based on the Akaike Information Criterion (AIC) [@Sakamoto1986]. The AIC estimates the relative amount of information lost by a given model, the less information a model loses, the higher the quality of that model. In the Plackett-Luce trees, the AIC is obtained by adding the maximized log likelihood ($L$) to the degrees of freedom ($\nu$). 

Equation [1]
$$AIC = -2L +  2\nu$$

```{r}
best_covar <- ""
if (isTREE) {
  best_covar <- paste0("Based on this method, the covariate(s) ", paste3(var_keep, lan = language),
                       " were identified as the most representative to the rankings. The table below ", 
                       "shows the sub-groups (tree nodes) identified with the selected covariate(s).")
}
```

`r  paste(best_covar, collapse='\n')`

```{r subgroups-found}
if(isTREE){
  try(
    kable(node_summary, 
        caption = paste0("Table 2.3. Summary of sub-groups (tree nodes) identified",
                         " by the model-based recursive partitioning tree applied to the Plackett-Luce rankings."),
        row.names = FALSE),
    silent = TRUE)
}

```


```{r no_tree}
no_tree <- ""
if (!isTREE) {
  no_tree <- 
    paste0("No split was found for the Plackett-Luce rankings using the selected ",
    "covariates. You may refer to Figure 2.2 and Figure 2.3 to check the performance of the tested ", options, " for '",  Ovname, "' in this experiment.")
}
```

`r paste(no_tree, collapse='\n')`


```{r pltree_legend}
pltree_text <- paste0("Figure 2.4. Plackett-Luce tree for '", Ovname, "'. The horizontal axis is the probability of winning (worth). Error bars show quasi-SEs. The gray vertical line indicates the average probability of winning (1/number of ", options, ").")

if (isTREE) {
  pltree_text <- paste0(pltree_text, " Nodes split by the following covariate and attribute ", paste(paste("Node", node_summary[,1], node_summary[,5]), collapse = ", and "), ".")
}

```

```{r pltree, dpi=500, asis=TRUE,fig.height=8,fig.width=10, fig.cap = pltree_text}
if (isTREE) {
try(plottree, silent = TRUE)
}
```

\

```{r error}
e <- ""
if (isFALSE(is.null(error))){
  e <- paste("During the execution of the requested analysis",
             "we also found the following error(s) that disabled",
             "the production of some outputs.",
             "Please report the error(s) to the ClimMob Team, via the",
             "'Chat bot' in your ClimMob account.")
}
```

`r paste(e, collapse = '\n')`

```{r error2}
if (isFALSE(is.null(error))){
print(error)
}
```


\pagebreak

# References

